"use strict";(self.webpackChunkstockfish_web=self.webpackChunkstockfish_web||[]).push([[490],{145:(e,s,t)=>{t.d(s,{_:()=>o});const o={chessDefaultPosition:"board-pos"}},147:(e,s,t)=>{t.d(s,{R:()=>o});const o={captureSound:new Audio("./sound/capture.mp3"),castlingSound:new Audio("./sound/castling.mp3"),checkSound:new Audio("./sound/check.mp3"),checkmateSound:new Audio("./sound/checkmate.mp3"),moveSound:new Audio("./sound/move.mp3")};for(let i of Object.keys(o))o[i].volume=.2},490:(e,s,t)=>{t.r(s),t.d(s,{default:()=>M});var o=t(371);const i="MyChessboard_MyChessboard__BjqC1",n="MyChessboard_chessboardWrapper__AtQ+W",a="MyChessboard_buttons__Dfxko";var c=t(445),l=t(43);class r{constructor(){this.stockfish=void 0,this.readyPromise=void 0,this.resolveReady=void 0,this.abortController=new AbortController,this.messageCallbacks=new Set,this._depth=void 0,this._thinkTime=1e3,this.handleEngineMessage=e=>{console.log("Engine message:",e.data);const s=this.parseMessage(e.data);this.messageCallbacks.forEach((e=>e(s))),"readyok"===e.data&&(this.resolveReady(),console.log("ENGINE IS READY!"))},this.stockfish=new Worker("./stockfish.js"),this.readyPromise=new Promise((e=>{this.resolveReady=e})),this.initializeEngine(),this.setThreads(4)}initializeEngine(){this.stockfish.addEventListener("message",this.handleEngineMessage,{signal:this.abortController.signal,once:!1}),this.stockfish.postMessage("uci"),this.stockfish.postMessage("isready")}waitForReady(){return this.readyPromise}parseMessage(e){var s,t,o,i;return{uciMessage:e,bestMove:null===(s=e.match(/bestmove\s+(\S+)/))||void 0===s?void 0:s[1],ponder:null===(t=e.match(/ponder\s+(\S+)/))||void 0===t?void 0:t[1],positionEvaluation:this.parseEvaluation(e),possibleMate:this.parseMate(e),pv:null===(o=e.match(/ pv\s+(.*)/))||void 0===o?void 0:o[1].split(" "),depth:Number(null===(i=e.match(/ depth\s+(\d+)/))||void 0===i?void 0:i[1])}}parseEvaluation(e){const s=e.match(/cp\s+(-?\d+)/);return s?parseInt(s[1],10)/100:void 0}parseMate(e){const s=e.match(/mate\s+(-?\d+)/);return s?parseInt(s[1],10):void 0}get depth(){return this._depth}get thinkTime(){return this._thinkTime}addMessageListener(e){this.messageCallbacks.add(e)}removeMessageListener(e){this.messageCallbacks.delete(e)}async evaluatePosition(e,s){console.log("evaluationg position..."),console.log("waiting for engine ready..."),await this.waitForReady(),console.log("promise is ready"),this.stop(),this.stockfish.postMessage("position fen ".concat(e)),console.log("current depth is ",this.depth);let t="go";t+=" depth ".concat(this.depth),t+=" movetime ".concat(s),console.log("go command: ",t),this.stockfish.postMessage(t)}stop(){this.stockfish.postMessage("stop")}terminate(){this.stop(),this.abortController.abort(),this.stockfish.postMessage("quit"),this.messageCallbacks.clear()}setThinkTime(e){this._thinkTime=e}setDepth(e){e<1?e=1:e>24&&(e=24),this._depth=e,console.log("depth of stockfish is set to ".concat(this.depth))}setSkillLevel(e){this.stockfish.postMessage("setoption name Skill Level value ".concat(e))}setThreads(e){this.stockfish.postMessage("setoption name Threads value ".concat(e))}setMultiPV(e){this.stockfish.postMessage("setoption name MultiPV value ".concat(e))}setLimitStrength(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1320;this.stockfish.postMessage("setoption name UCI_LimitStrength value ".concat(e)),this.stockfish.postMessage("setoption name UCI_Elo value ".concat(s))}}var h=t(629),d=t.n(h),u=t(846),m=t(147),p=t(2),g=t(145),v=t(579);const k={easy:{text:"\u041b\u0435\u0433\u043a\u043e \ud83e\udd13",skill:2,depth:5,thinkTime:500,multiPV:3},normal:{text:"\u041d\u043e\u0440\u043c\u0430\u043b\u044c\u043d\u043e \ud83e\uddd0",skill:10,depth:12,thinkTime:1e3,multiPV:3},hard:{text:"\u0421\u043b\u043e\u0436\u043d\u043e \ud83d\ude35",skill:20,depth:22,thinkTime:3e3,threads:6,multiPV:1}},f=e=>{let{className:s,defaultPosition:t}=e;const h=(0,p.zy)(),f=(0,l.useMemo)((()=>new URLSearchParams(h.search)),[h.search]),M=(0,l.useMemo)((()=>new(d())),[]);t=(0,l.useMemo)((()=>t||f.get(g._.chessDefaultPosition)||M.fen()),[t,f,M]);const b=(0,l.useRef)(null),[y,S]=(0,l.useState)(t||f.get(g._.chessDefaultPosition)||M.fen()),[_,w]=(0,l.useState)("easy"),[C,P]=(0,l.useState)(!0);function x(e){const s=M.move(e);return S(M.fen()),console.log(s),null!==s&&(M.history().length>=10&&P(!1),M.game_over()||M.in_draw()?(m.R.checkmateSound.play(),!1):M.in_check()?(m.R.checkSound.play(),!0):"O-O-O"===s.san||"O-O"===s.san?(m.R.castlingSound.play(),!0):s.captured?(m.R.captureSound.play(),!0):(m.R.moveSound.play(),!0))}(0,l.useEffect)((()=>{const e=new r;b.current=e;const s=k[_];e.setLimitStrength(!1),e.setSkillLevel(s.skill),e.setDepth(s.depth),s.elo&&e.setLimitStrength(!0,s.elo),s.threads&&e.setThreads(s.threads),s.multiPV?e.setMultiPV(s.multiPV):e.setMultiPV(1),console.log("Stockfish level set to: ".concat(_),s)}),[_,b]),(0,l.useEffect)((()=>{M.load(t)}),[t,M]);const E=e=>{console.log(e),console.log("Best move received:",e.bestMove);const s=b.current,t=[];if(e.pv&&e.bestMove){t.push(e.bestMove);const o=function(e){const s=e.map(((e,s)=>Math.exp(.3*-s))),t=s.reduce(((e,s)=>e+s),0);let o=Math.random()*t;return e.find(((e,t)=>(o-=s[t],o<=0)))||e[0]}(t),i=x({from:o.substring(0,2),to:o.substring(2,4),promotion:o.substring(4,5)});s.removeMessageListener(E),i||s.stop()}};return(0,l.useEffect)((()=>()=>b.current.terminate()),[b]),(0,v.jsx)("div",{className:(0,o.x)(i,{},[s]),children:(0,v.jsxs)("div",{className:n,children:[(0,v.jsx)("div",{className:a,children:Object.entries(k).map((e=>{let[s,t]=e;return(0,v.jsx)(c.$n,{onClick:()=>w(s),theme:c.Ox.CLASSIC,active:_===s,children:t.text},"".concat(s))}))}),(0,v.jsx)(u.Ve,{id:"PlayVsStockfish",position:y,onPieceDrop:function(e,s,t){console.log(e,s,t);const o=x({from:e,to:s,promotion:t[1].toLowerCase()});return o&&setTimeout((()=>{!async function(){const e=b.current;e.addMessageListener(E),console.log("finding best move...");try{await e.evaluatePosition(M.fen(),C?Math.ceil(500):1e3)}catch(s){throw e.removeMessageListener(E),s}}()}),500),o}}),(0,v.jsxs)("div",{className:a,children:[(0,v.jsx)(c.$n,{onClick:()=>{M.reset(),S(M.fen())},children:"\u041d\u043e\u0432\u0430\u044f \u0438\u0433\u0440\u0430"}),(0,v.jsx)(c.$n,{onClick:()=>{M.undo(),M.undo(),S(M.fen())},children:"\u041d\u0430\u0437\u0430\u0434"})]})]})})},M=e=>{let{className:s}=e;return(0,v.jsx)("div",{children:(0,v.jsx)(f,{})})}}}]);
//# sourceMappingURL=490.eb92eb2f.chunk.js.map